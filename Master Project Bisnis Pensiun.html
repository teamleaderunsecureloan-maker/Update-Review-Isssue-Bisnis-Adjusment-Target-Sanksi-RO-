<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Timeline Dashboard - Enhanced Template</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #0052D4; --secondary-color: #65C7F7; --accent-color: #9CECFB;
            --text-dark: #2c3e50; --text-light: #5a6a7a; --bg-color: #f8f9fa;
            --card-bg: #ffffff; --success-color: #28a745; --warning-color: #ffc107;
            --danger-color: #dc3545; --shadow: 0 7px 15px rgba(0, 0, 0, 0.08);
        }
        body { font-family: 'Poppins', 'Segoe UI', sans-serif; background-color: var(--bg-color); color: var(--text-dark); margin: 0; padding: 0; }
        .header { position: relative; padding: 60px 20px; text-align: center; background-size: cover; background-position: center; background-attachment: fixed; min-height: 300px; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .header::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.4); z-index: 1; }
        .header-content { position: relative; z-index: 2; color: white; max-width: 900px; }
        .header h1 { font-size: 2.8em; font-weight: 700; margin-bottom: 15px; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5); cursor: pointer; }
        .header h1:hover { opacity: 0.9; }
        .header p { font-size: 1.2em; margin: 10px 0; text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5); line-height: 1.6; }
        .header-actions { position: absolute; top: 20px; right: 20px; display: flex; gap: 10px; z-index: 3; }
        .controls { max-width: 1000px; margin: 30px auto; padding: 15px; background-color: var(--card-bg); border-radius: 12px; box-shadow: var(--shadow); display: flex; justify-content: space-between; align-items: center; gap: 20px; flex-wrap: wrap; }
        .controls input, .controls select { border: 1px solid #ddd; border-radius: 8px; padding: 8px 12px; font-size: 14px; }
        .timeline { position: relative; max-width: 1000px; margin: 0 auto 50px auto; }
        .timeline::before { content: ''; position: absolute; width: 3px; background: linear-gradient(to bottom, var(--primary-color), var(--accent-color)); top: 0; bottom: 0; left: 50%; margin-left: -1.5px; border-radius: 3px; }
        .timeline-item { padding: 10px 40px; position: relative; width: 50%; box-sizing: border-box; cursor: pointer; }
        .timeline-item.left { left: 0; }
        .timeline-item.right { left: 50%; }
        .timeline-icon { position: absolute; width: 40px; height: 40px; right: -20px; top: 30px; background-color: var(--card-bg); border: 3px solid var(--primary-color); border-radius: 50%; z-index: 10; display: flex; justify-content: center; align-items: center; font-size: 1.2em; color: var(--primary-color); transition: transform 0.3s ease; }
        .timeline-item.right .timeline-icon { left: -20px; }
        .timeline-item:hover .timeline-icon { transform: scale(1.2); }
        .card { padding: 25px; background-color: var(--card-bg); position: relative; border-radius: 12px; box-shadow: var(--shadow); border-top: 4px solid var(--primary-color); transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .timeline-item:hover .card { transform: translateY(-5px); box-shadow: 0 12px 25px rgba(0, 0, 0, 0.1); }
        .card-date { font-weight: 600; color: var(--primary-color); margin-bottom: 10px; font-size: 0.9em; }
        .card-title { margin-top: 0; font-size: 1.3em; font-weight: 600; }
        .card-content p { font-size: 0.95em; line-height: 1.7; color: var(--text-light); }
        .card-actions { margin-top: 15px; display: flex; gap: 10px; }
        .btn { background-color: #eef1f5; color: var(--text-light); border: none; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-size: 0.85em; font-weight: 500; text-decoration: none; display: inline-flex; align-items: center; gap: 8px; transition: background-color 0.3s, color 0.3s; }
        .btn:hover { background-color: var(--primary-color); color: white; }
        .btn-danger { background-color: #ffebee; color: var(--danger-color); }
        .btn-danger:hover { background-color: var(--danger-color); color: white; }
        .btn i { font-size: 1.1em; }
        .timeline-item.stalled .timeline-icon, .timeline-item.hold .timeline-icon { border-color: var(--danger-color); color: var(--danger-color); animation: pulse 1.5s infinite; }
        .timeline-item.stalled .card, .timeline-item.hold .card { border-top-color: var(--danger-color); }
        .timeline-item.stalled .card-date, .timeline-item.hold .card-date { color: var(--danger-color); }
        .timeline-item.pending .timeline-icon { border-color: var(--warning-color); color: var(--warning-color); }
        .timeline-item.pending .card { border-top-color: var(--warning-color); }
        .timeline-item.pending .card-date { color: var(--warning-color); }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); } 100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); } }
        .footer { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; padding: 50px 20px; margin-top: 80px; }
        .footer-container { max-width: 1000px; margin: 0 auto; }
        .footer h2 { font-size: 2em; margin-bottom: 30px; text-align: center; }
        .footer-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px; }
        .footer-section { background: rgba(255, 255, 255, 0.1); padding: 25px; border-radius: 12px; backdrop-filter: blur(10px); }
        .footer-section h3 { font-size: 1.3em; margin-top: 0; margin-bottom: 15px; border-bottom: 2px solid rgba(255, 255, 255, 0.3); padding-bottom: 10px; }
        .footer-section p { font-size: 0.95em; line-height: 1.8; margin: 10px 0; }
        .footer-section ul { margin: 10px 0; padding-left: 20px; }
        .footer-section li { margin: 8px 0; }
        .footer-summary { background: rgba(255, 255, 255, 0.15); padding: 25px; border-radius: 12px; border-left: 4px solid rgba(255, 255, 255, 0.5); }
        .footer-summary h3 { margin-top: 0; font-size: 1.2em; }
        .modal { position: fixed; inset: 0; background-color: rgba(0,0,0,0.5); z-index: 100; display: none; align-items: center; justify-content: center; padding: 20px; overflow-y: auto; }
        .modal-content { background-color: white; border-radius: 12px; padding: 30px; width: 100%; max-width: 600px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); position: relative; }
        .modal-close { position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 24px; cursor: pointer; color: #999; }
        .modal-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .modal-grid .col-span-2 { grid-column: span 2; }
        .modal-grid label { font-weight: 500; font-size: 14px; margin-bottom: 5px; display: block; }
        .modal-grid input, .modal-grid select, .modal-grid textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }
        .file-list-item { display: flex; justify-content: space-between; align-items: center; background-color: #f0f4f8; padding: 5px 10px; border-radius: 6px; margin-bottom: 5px; }
        .comment-item { background-color: #f0f4f8; padding: 10px; border-radius: 6px; margin-bottom: 8px; }
        .modal-actions { text-align: right; margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end; }
        .bg-preview { width: 100%; height: 150px; border-radius: 8px; background-size: cover; background-position: center; margin-top: 10px; border: 2px solid #ddd; }
        @media screen and (max-width: 768px) { .timeline::before { left: 20px; } .timeline-item { width: 100%; padding-left: 60px; padding-right: 15px; } .timeline-item.left, .timeline-item.right { left: 0; } .timeline-icon, .timeline-item.right .timeline-icon { left: 0; } .controls { flex-direction: column; } .header-actions { position: static; margin-top: 20px; } .footer-grid { grid-template-columns: 1fr; } .header h1 { font-size: 1.8em; } }
    </style>
</head>
<body>

    <div class="header" id="headerBg">
        <div class="header-actions">
            <button id="editTitleBtn" class="btn"><i class="fa-solid fa-pen-to-square"></i> Edit Judul</button>
            <button id="editBgBtn" class="btn"><i class="fa-solid fa-image"></i> Edit Background</button>
            <button id="addTimelineBtn" class="btn"><i class="fa-solid fa-plus"></i> Tambah Item</button>
        </div>
        <div class="header-content">
            <h1 id="projectTitle" title="Klik untuk mengubah judul">Dashboard Proyek</h1>
            <p id="projectDesc">Monitoring Progres Proyek</p>
            <p id="projectContext" style="font-size: 0.95em; font-style: italic; margin-top: 20px;"></p>
        </div>
    </div>

    <div class="controls">
        <div>
            <input id="searchInput" type="text" placeholder="Cari aktivitas...">
            <select id="filterStatus">
                <option value="all">Semua Status</option>
                <option value="done">Selesai</option>
                <option value="pending">Tertunda</option>
                <option value="stalled">Terhenti</option>
            </select>
        </div>
        <div>
            <button id="exportBtn" class="btn"><i class="fa-solid fa-download"></i> Export Data</button>
            <button id="resetBtn" class="btn btn-danger"><i class="fa-solid fa-trash"></i> Reset Data</button>
        </div>
    </div>

    <div id="timeline" class="timeline">
        <!-- Timeline items akan diinjeksi oleh JavaScript -->
    </div>

    <!-- Footer Summary -->
    <div class="footer">
        <div class="footer-container">
            <h2>Ringkasan Proyek</h2>
            <div class="footer-grid">
                <div class="footer-section">
                    <h3><i class="fa-solid fa-info-circle"></i> Latar Belakang</h3>
                    <p id="footerBackground">Proyek ini dikerjakan untuk memahami dan mengatasi tantangan organisasi. Silakan edit bagian ini untuk menambahkan konteks proyek Anda.</p>
                </div>
                <div class="footer-section">
                    <h3><i class="fa-solid fa-chart-line"></i> Perkembangan</h3>
                    <p id="footerProgress">Proyek telah melalui beberapa tahap penting. Silakan edit bagian ini untuk menambahkan ringkasan perkembangan.</p>
                </div>
                <div class="footer-section">
                    <h3><i class="fa-solid fa-lightbulb"></i> Temuan Kunci</h3>
                    <p id="footerFindings">Beberapa temuan penting telah diidentifikasi melalui proses analisis. Silakan edit bagian ini untuk menambahkan temuan kunci Anda.</p>
                </div>
                <div class="footer-section">
                    <h3><i class="fa-solid fa-arrow-right"></i> Rekomendasi</h3>
                    <p id="footerRecommendation">Berdasarkan temuan, beberapa rekomendasi tindak lanjut diusulkan. Silakan edit bagian ini untuk menambahkan rekomendasi Anda.</p>
                </div>
            </div>
            <div class="footer-summary">
                <h3>Catatan Penting</h3>
                <p id="footerNote">Dashboard ini dirancang sebagai alat komunikasi yang komprehensif. Setiap bagian dapat diedit untuk menyesuaikan dengan kebutuhan proyek Anda. Silakan klik tombol "Edit Footer" untuk memperbarui informasi.</p>
                <button id="editFooterBtn" class="btn" style="background-color: rgba(255, 255, 255, 0.2); color: white; margin-top: 15px;"><i class="fa-solid fa-pen"></i> Edit Footer</button>
            </div>
        </div>
    </div>

    <!-- Modal untuk Edit Judul Proyek -->
    <div id="editTitleModal" class="modal">
        <div class="modal-content">
            <button id="closeTitleModal" class="modal-close">&times;</button>
            <h2>Edit Judul Proyek</h2>
            <div class="modal-grid">
                <div class="col-span-2">
                    <label for="titleInput">Judul Proyek</label>
                    <input type="text" id="titleInput" placeholder="Masukkan judul proyek...">
                </div>
                <div class="col-span-2">
                    <label for="descInput">Deskripsi Proyek</label>
                    <textarea id="descInput" rows="3" placeholder="Masukkan deskripsi proyek..."></textarea>
                </div>
                <div class="col-span-2">
                    <label for="contextInput">Konteks Proyek (Opsional)</label>
                    <textarea id="contextInput" rows="2" placeholder="Mengapa proyek ini dikerjakan? Apa latar belakangnya?"></textarea>
                </div>
            </div>
            <div class="modal-actions">
                <button id="saveTitleBtn" class="btn" style="background-color: var(--primary-color); color: white;">Simpan</button>
                <button id="closeTitleBtn" class="btn">Batal</button>
            </div>
        </div>
    </div>

    <!-- Modal untuk Edit Background -->
    <div id="editBgModal" class="modal">
        <div class="modal-content">
            <button id="closeBgModal" class="modal-close">&times;</button>
            <h2>Edit Background Header</h2>
            <div class="modal-grid">
                <div class="col-span-2">
                    <label for="bgImageInput">Upload Gambar</label>
                    <input type="file" id="bgImageInput" accept="image/*" style="margin-bottom: 10px;">
                    <small style="color: #666;">Atau paste URL gambar di bawah</small>
                </div>
                <div class="col-span-2">
                    <label for="bgUrlInput">URL Gambar</label>
                    <input type="text" id="bgUrlInput" placeholder="https://example.com/image.jpg">
                </div>
                <div class="col-span-2">
                    <label>Preview</label>
                    <div id="bgPreview" class="bg-preview"></div>
                </div>
            </div>
            <div class="modal-actions">
                <button id="saveBgBtn" class="btn" style="background-color: var(--primary-color); color: white;">Simpan</button>
                <button id="closeBgBtn" class="btn">Batal</button>
            </div>
        </div>
    </div>

    <!-- Modal untuk Edit Footer -->
    <div id="editFooterModal" class="modal">
        <div class="modal-content">
            <button id="closeFooterModal" class="modal-close">&times;</button>
            <h2>Edit Ringkasan Proyek</h2>
            <div class="modal-grid">
                <div class="col-span-2">
                    <label for="footerBgInput">Latar Belakang Proyek</label>
                    <textarea id="footerBgInput" rows="3" placeholder="Mengapa proyek ini dikerjakan?"></textarea>
                </div>
                <div class="col-span-2">
                    <label for="footerProgInput">Perkembangan</label>
                    <textarea id="footerProgInput" rows="3" placeholder="Apa yang sudah dicapai?"></textarea>
                </div>
                <div class="col-span-2">
                    <label for="footerFindInput">Temuan Kunci</label>
                    <textarea id="footerFindInput" rows="3" placeholder="Apa yang ditemukan?"></textarea>
                </div>
                <div class="col-span-2">
                    <label for="footerRecInput">Rekomendasi Tindak Lanjut</label>
                    <textarea id="footerRecInput" rows="3" placeholder="Apa yang harus dilakukan?"></textarea>
                </div>
                <div class="col-span-2">
                    <label for="footerNoteInput">Catatan Penting</label>
                    <textarea id="footerNoteInput" rows="2" placeholder="Catatan tambahan..."></textarea>
                </div>
            </div>
            <div class="modal-actions">
                <button id="saveFooterBtn" class="btn" style="background-color: var(--primary-color); color: white;">Simpan</button>
                <button id="closeFooterBtn" class="btn">Batal</button>
            </div>
        </div>
    </div>

    <!-- Modal untuk Tambah Item Timeline -->
    <div id="addItemModal" class="modal">
        <div class="modal-content">
            <button id="closeAddModal" class="modal-close">&times;</button>
            <h2>Tambah Item Timeline</h2>
            <div class="modal-grid">
                <div>
                    <label for="newItemDate">Tanggal</label>
                    <input type="date" id="newItemDate">
                </div>
                <div>
                    <label for="newItemStatus">Status</label>
                    <select id="newItemStatus">
                        <option value="done">Selesai</option>
                        <option value="pending">Tertunda</option>
                        <option value="stalled">Terhenti</option>
                    </select>
                </div>
                <div class="col-span-2">
                    <label for="newItemTitle">Judul</label>
                    <input type="text" id="newItemTitle" placeholder="Masukkan judul item...">
                </div>
                <div class="col-span-2">
                    <label for="newItemDesc">Deskripsi</label>
                    <textarea id="newItemDesc" rows="3" placeholder="Masukkan deskripsi item..."></textarea>
                </div>
            </div>
            <div class="modal-actions">
                <button id="saveItemBtn" class="btn" style="background-color: var(--primary-color); color: white;">Tambah</button>
                <button id="closeAddBtn" class="btn">Batal</button>
            </div>
        </div>
    </div>

    <!-- Modal untuk Edit Item Timeline -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <button id="closeModal" class="modal-close">&times;</button>
            <h2 id="modalTitle" class="card-title">Edit Aktivitas</h2>
            <div class="modal-grid">
                <div class="col-span-2">
                    <label for="modalItemTitle">Judul Item</label>
                    <input type="text" id="modalItemTitle" placeholder="Masukkan judul item...">
                </div>
                <div class="col-span-2">
                    <label for="modalDesc">Deskripsi</label>
                    <textarea id="modalDesc" rows="3"></textarea>
                </div>
                <div>
                    <label for="modalStatus">Status</label>
                    <select id="modalStatus">
                        <option value="done">Selesai</option>
                        <option value="pending">Tertunda</option>
                        <option value="stalled">Terhenti</option>
                    </select>
                </div>
                <div>
                    <label for="modalDate">Tanggal</label>
                    <input type="date" id="modalDate">
                </div>
                <div class="col-span-2">
                    <label>Lampiran</label>
                    <input type="file" id="fileInput" style="margin-bottom: 10px;">
                    <div id="fileList"></div>
                </div>
                <div class="col-span-2">
                    <label>Komentar</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="commentInput" placeholder="Tambah komentar baru..." style="flex-grow: 1;">
                        <button id="addCommentBtn" class="btn">Tambah</button>
                    </div>
                    <div id="commentsArea" style="max-height: 150px; overflow-y: auto; margin-top: 10px;"></div>
                </div>
            </div>
            <div class="modal-actions">
                <button id="deleteItemBtn" class="btn btn-danger"><i class="fa-solid fa-trash"></i> Hapus Item</button>
                <button id="saveModal" class="btn" style="background-color: var(--primary-color); color: white;">Simpan Perubahan</button>
            </div>
        </div>
    </div>

<script>
const STORAGE_KEY = 'project_timeline_data_enhanced';

const defaultProjectData = {
    title: 'Dashboard Proyek',
    desc: 'Monitoring Progres Proyek',
    context: 'Proyek ini dikerjakan untuk memahami dan mengatasi tantangan organisasi.',
    bgImage: null,
    footer: {
        background: 'Proyek ini dikerjakan untuk memahami dan mengatasi tantangan organisasi. Silakan edit bagian ini untuk menambahkan konteks proyek Anda.',
        progress: 'Proyek telah melalui beberapa tahap penting. Silakan edit bagian ini untuk menambahkan ringkasan perkembangan.',
        findings: 'Beberapa temuan penting telah diidentifikasi melalui proses analisis. Silakan edit bagian ini untuk menambahkan temuan kunci Anda.',
        recommendation: 'Berdasarkan temuan, beberapa rekomendasi tindak lanjut diusulkan. Silakan edit bagian ini untuk menambahkan rekomendasi Anda.',
        note: 'Dashboard ini dirancang sebagai alat komunikasi yang komprehensif. Setiap bagian dapat diedit untuk menyesuaikan dengan kebutuhan proyek Anda.'
    },
    items: [
        { id: 'T1', date: '2025-07-10', title: 'Persiapan Materi FGD', desc: 'Menyusun materi diskusi yang provokatif untuk menggali akar masalah.', status: 'done', files: [], comments: [] },
        { id: 'T2', date: '2025-07-15', title: 'Pelaksanaan FGD Lintas Area', desc: 'FGD via Zoom untuk validasi kondisi lapangan dan menyatukan persepsi.', status: 'done', files: [], comments: [] },
        { id: 'T3', date: '2025-07-21', title: 'Penyebaran Kuisioner', desc: 'Kuisioner disebar ke 3 level untuk kuantifikasi data.', status: 'done', files: [], comments: [] },
        { id: 'T4', date: '2025-08-07', title: 'Analisa Hasil Kuisioner', desc: 'Analisis statistik menunjukkan dampak berantai dari kebijakan.', status: 'done', files: [], comments: [] },
        { id: 'T5', date: '2025-08-27', title: 'Perumusan Usulan Strategis', desc: 'Usulan konkret dirumuskan berdasarkan hasil analisa.', status: 'done', files: [], comments: [] },
        { id: 'T6', date: '2025-09-02', title: 'Meeting Lintas Divisi', desc: 'Penyamaan persepsi awal dengan divisi terkait.', status: 'done', files: [], comments: [] },
        { id: 'T7', date: '2025-09-24', title: 'Pengiriman Memo & Penerimaan Opini', desc: 'Memo resmi dikirim dan opini diterima.', status: 'done', files: [], comments: [] },
        { id: 'T8', date: '2025-11-12', title: 'Proses Terhenti: Menunggu Tindak Lanjut', desc: 'Opini sudah diterima, namun belum ada langkah lanjutan.', status: 'stalled', files: [], comments: [] }
    ]
};

let projectData = {};

function loadData() {
    const savedData = localStorage.getItem(STORAGE_KEY);
    projectData = savedData ? JSON.parse(savedData) : JSON.parse(JSON.stringify(defaultProjectData));
    updateHeader();
    updateFooter();
}

function saveData() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(projectData));
}

function updateHeader() {
    document.getElementById('projectTitle').innerText = projectData.title;
    document.getElementById('projectDesc').innerText = projectData.desc;
    document.getElementById('projectContext').innerText = projectData.context || '';
    if (projectData.bgImage) {
        document.getElementById('headerBg').style.backgroundImage = `url('${projectData.bgImage}')`;
    }
}

function updateFooter() {
    const footer = projectData.footer || {};
    document.getElementById('footerBackground').innerText = footer.background || '';
    document.getElementById('footerProgress').innerText = footer.progress || '';
    document.getElementById('footerFindings').innerText = footer.findings || '';
    document.getElementById('footerRecommendation').innerText = footer.recommendation || '';
    document.getElementById('footerNote').innerText = footer.note || '';
}

function generateId() {
    return 'T' + (Math.max(...projectData.items.map(i => parseInt(i.id.substring(1)) || 0)) + 1);
}

function renderTimeline() {
    const timelineContainer = document.getElementById('timeline');
    timelineContainer.innerHTML = '';
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const statusFilter = document.getElementById('filterStatus').value;

    const filteredData = projectData.items.filter(item => {
        const matchesSearch = item.title.toLowerCase().includes(searchTerm) || item.desc.toLowerCase().includes(searchTerm);
        const matchesStatus = statusFilter === 'all' || item.status === statusFilter;
        return matchesSearch && matchesStatus;
    });

    filteredData.forEach((item, index) => {
        const side = index % 2 === 0 ? 'left' : 'right';
        const timelineItem = document.createElement('div');
        timelineItem.className = `timeline-item ${side} ${item.status}`;
        timelineItem.innerHTML = `
            <div class="timeline-icon"><i class="fa-solid fa-circle-check"></i></div>
            <div class="card">
                <div class="card-date">${item.date}</div>
                <h3 class="card-title">${item.title}</h3>
                <div class="card-content"><p>${item.desc}</p></div>
                <div class="card-actions">
                    <button class="btn" onclick="openEditModal('${item.id}')"><i class="fa-solid fa-pen"></i> Edit</button>
                </div>
            </div>
        `;
        timelineItem.onclick = (e) => {
            if (!e.target.closest('button')) openEditModal(item.id);
        };
        timelineContainer.appendChild(timelineItem);
    });
}

let currentItemId = null;
const editModal = document.getElementById('editModal');
const editTitleModal = document.getElementById('editTitleModal');
const editBgModal = document.getElementById('editBgModal');
const editFooterModal = document.getElementById('editFooterModal');
const addItemModal = document.getElementById('addItemModal');

function openEditModal(id) {
    currentItemId = id;
    const item = projectData.items.find(i => i.id === id);
    document.getElementById('modalTitle').innerText = 'Edit Aktivitas: ' + item.title;
    document.getElementById('modalItemTitle').value = item.title;
    document.getElementById('modalDesc').value = item.desc;
    document.getElementById('modalStatus').value = item.status;
    document.getElementById('modalDate').value = item.date;
    renderFileList(item);
    renderComments(item);
    editModal.style.display = 'flex';
}

function closeEditModal() {
    editModal.style.display = 'none';
    currentItemId = null;
}

function openEditTitleModal() {
    document.getElementById('titleInput').value = projectData.title;
    document.getElementById('descInput').value = projectData.desc;
    document.getElementById('contextInput').value = projectData.context || '';
    editTitleModal.style.display = 'flex';
}

function closeEditTitleModal() {
    editTitleModal.style.display = 'none';
}

function openEditBgModal() {
    document.getElementById('bgUrlInput').value = projectData.bgImage || '';
    updateBgPreview();
    editBgModal.style.display = 'flex';
}

function closeEditBgModal() {
    editBgModal.style.display = 'none';
}

function openEditFooterModal() {
    const footer = projectData.footer || {};
    document.getElementById('footerBgInput').value = footer.background || '';
    document.getElementById('footerProgInput').value = footer.progress || '';
    document.getElementById('footerFindInput').value = footer.findings || '';
    document.getElementById('footerRecInput').value = footer.recommendation || '';
    document.getElementById('footerNoteInput').value = footer.note || '';
    editFooterModal.style.display = 'flex';
}

function closeEditFooterModal() {
    editFooterModal.style.display = 'none';
}

function openAddItemModal() {
    document.getElementById('newItemDate').value = new Date().toISOString().split('T')[0];
    document.getElementById('newItemStatus').value = 'pending';
    document.getElementById('newItemTitle').value = '';
    document.getElementById('newItemDesc').value = '';
    addItemModal.style.display = 'flex';
}

function closeAddItemModal() {
    addItemModal.style.display = 'none';
}

function updateBgPreview() {
    const url = document.getElementById('bgUrlInput').value;
    if (url) {
        document.getElementById('bgPreview').style.backgroundImage = `url('${url}')`;
    }
}

function renderFileList(item) {
    const listEl = document.getElementById('fileList');
    listEl.innerHTML = (item.files || []).map((file, index) => `
        <div class="file-list-item">
            <a href="${file.dataUrl}" download="${file.name}" class="btn" style="background:none; color:var(--primary-color);">${file.name}</a>
            <button onclick="removeFile(event, ${index})" class="btn btn-danger" style="padding: 4px 8px;">&times;</button>
        </div>`).join('');
}

function renderComments(item) {
    const areaEl = document.getElementById('commentsArea');
    areaEl.innerHTML = (item.comments || []).map((comment) => `
        <div class="comment-item">
            <p>${comment.text}</p>
            <small style="color: #999;">${new Date(comment.at).toLocaleString()}</small>
        </div>`).join('');
}

document.getElementById('editTitleBtn').addEventListener('click', openEditTitleModal);
document.getElementById('closeTitleModal').addEventListener('click', closeEditTitleModal);
document.getElementById('closeTitleBtn').addEventListener('click', closeEditTitleModal);

document.getElementById('saveTitleBtn').addEventListener('click', () => {
    projectData.title = document.getElementById('titleInput').value || 'Dashboard Proyek';
    projectData.desc = document.getElementById('descInput').value || 'Monitoring Progres Proyek';
    projectData.context = document.getElementById('contextInput').value || '';
    saveData();
    updateHeader();
    closeEditTitleModal();
});

document.getElementById('editBgBtn').addEventListener('click', openEditBgModal);
document.getElementById('closeBgModal').addEventListener('click', closeEditBgModal);
document.getElementById('closeBgBtn').addEventListener('click', closeEditBgModal);

document.getElementById('bgImageInput').addEventListener('change', (e) => {
    if (e.target.files[0]) {
        const reader = new FileReader();
        reader.onload = (event) => {
            document.getElementById('bgUrlInput').value = event.target.result;
            updateBgPreview();
        };
        reader.readAsDataURL(e.target.files[0]);
    }
});

document.getElementById('bgUrlInput').addEventListener('input', updateBgPreview);

document.getElementById('saveBgBtn').addEventListener('click', () => {
    projectData.bgImage = document.getElementById('bgUrlInput').value || null;
    saveData();
    updateHeader();
    closeEditBgModal();
});

document.getElementById('editFooterBtn').addEventListener('click', openEditFooterModal);
document.getElementById('closeFooterModal').addEventListener('click', closeEditFooterModal);
document.getElementById('closeFooterBtn').addEventListener('click', closeEditFooterModal);

document.getElementById('saveFooterBtn').addEventListener('click', () => {
    projectData.footer = {
        background: document.getElementById('footerBgInput').value || '',
        progress: document.getElementById('footerProgInput').value || '',
        findings: document.getElementById('footerFindInput').value || '',
        recommendation: document.getElementById('footerRecInput').value || '',
        note: document.getElementById('footerNoteInput').value || ''
    };
    saveData();
    updateFooter();
    closeEditFooterModal();
});

document.getElementById('addTimelineBtn').addEventListener('click', openAddItemModal);
document.getElementById('closeAddModal').addEventListener('click', closeAddItemModal);
document.getElementById('closeAddBtn').addEventListener('click', closeAddItemModal);

document.getElementById('saveItemBtn').addEventListener('click', () => {
    const newItem = {
        id: generateId(),
        date: document.getElementById('newItemDate').value,
        title: document.getElementById('newItemTitle').value || 'Item Baru',
        desc: document.getElementById('newItemDesc').value || 'Deskripsi item',
        status: document.getElementById('newItemStatus').value,
        files: [],
        comments: []
    };
    projectData.items.push(newItem);
    saveData();
    renderTimeline();
    closeAddItemModal();
});

document.getElementById('saveModal').addEventListener('click', () => {
    if (!currentItemId) return;
    const item = projectData.items.find(i => i.id === currentItemId);
    item.title = document.getElementById('modalItemTitle').value || 'Item Tanpa Judul';
    item.desc = document.getElementById('modalDesc').value;
    item.status = document.getElementById('modalStatus').value;
    item.date = document.getElementById('modalDate').value;
    saveData();
    renderTimeline();
    closeEditModal();
});

document.getElementById('deleteItemBtn').addEventListener('click', () => {
    if (confirm('Apakah Anda yakin ingin menghapus item ini?')) {
        projectData.items = projectData.items.filter(i => i.id !== currentItemId);
        saveData();
        renderTimeline();
        closeEditModal();
    }
});

document.getElementById('fileInput').addEventListener('change', async (e) => {
    if (!currentItemId || !e.target.files[0]) return;
    const file = e.target.files[0];
    const reader = new FileReader();
    reader.onload = () => {
        const item = projectData.items.find(i => i.id === currentItemId);
        item.files = item.files || [];
        item.files.push({ name: file.name, dataUrl: reader.result });
        saveData();
        renderFileList(item);
    };
    reader.readAsDataURL(file);
    e.target.value = '';
});

function removeFile(event, index) {
    event.stopPropagation();
    const item = projectData.items.find(i => i.id === currentItemId);
    item.files.splice(index, 1);
    saveData();
    renderFileList(item);
}

document.getElementById('addCommentBtn').addEventListener('click', () => {
    const input = document.getElementById('commentInput');
    if (!currentItemId || !input.value.trim()) return;
    const item = projectData.items.find(i => i.id === currentItemId);
    item.comments = item.comments || [];
    item.comments.push({ text: input.value.trim(), at: new Date().toISOString() });
    saveData();
    renderComments(item);
    input.value = '';
});

document.getElementById('closeModal').addEventListener('click', closeEditModal);
document.getElementById('searchInput').addEventListener('input', renderTimeline);
document.getElementById('filterStatus').addEventListener('change', renderTimeline);

document.getElementById('exportBtn').addEventListener('click', () => {
    const blob = new Blob([JSON.stringify(projectData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${projectData.title.replace(/\s+/g, '-')}-data.json`;
    a.click();
    URL.revokeObjectURL(url);
});

document.getElementById('resetBtn').addEventListener('click', () => {
    if (confirm('Apakah Anda yakin ingin mereset semua data? Tindakan ini tidak bisa dibatalkan.')) {
        localStorage.removeItem(STORAGE_KEY);
        loadData();
        renderTimeline();
    }
});

window.onload = () => {
    loadData();
    renderTimeline();
};
</script>
</body>
</html>